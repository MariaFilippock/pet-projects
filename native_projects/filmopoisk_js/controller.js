import{ApiClient}from"./api.js";import{EVERY_YEAR,FILTER_YEAR_TYPE,PAGE_TYPE}from"./const.js";import{Store}from"./store.js";import{renderSideBar}from"./src/components/SideBar/SideBar.js";import{renderMovieCard}from"./src/components/MovieCard/MovieCard.js";import{renderFilmList}from"./src/components/MovieList/MovieList.js";import{renderDropdownMovieList}from"./src/components/DropdownMovieList/DropdownMovieList.js";const root=document.getElementById("root");function renderApp(){root.innerHTML='<div id="preloader-wrapper" class="preloader-wrapper">\n        <div id="preloader"></div>\n    </div>\n\n    <nav class="header">\n        <div class="search-container">\n            <div class="nav-brand" id="nav-brand">\u0424\u0438\u043b\u044c\u043c\u043e\u043f\u043e\u0438\u0441\u043a</div>\n            <div class="form-search" id="form-search">\n                <input id="search-input" type="text" placeholder="\u0424\u0438\u043b\u044c\u043c\u044b" autoComplete="off">\n                    <div id="btn-search" class="btn-search">\n                        <ion-icon name="search-outline"></ion-icon>\n                    </div>\n                    <div id="dropdown-container"></div>\n            </div>\n        </div>\n    </nav>\n\n    <div class="container">\n        <div id="wrapper-sidebar" class="wrapper-sidebar"></div>\n        <div id="wrapper" class="wrapper"></div>\n    </div>',attachHTMLElementsHandlers()}function throttle(e,t){let n=!1;return function(...i){n||(e.apply(this,i),n=!0,setTimeout(()=>{n=!1},t))}}document.addEventListener("click",handleClickOutsideSearchInput);export function getHTMLElements(){return{searchBtn:document.getElementById("btn-search"),searchInput:document.getElementById("search-input"),formSearch:document.getElementById("form-search"),navBrand:document.getElementById("nav-brand"),loader:document.getElementById("preloader-wrapper"),wrapperSidebar:document.getElementById("wrapper-sidebar"),dropdownContainer:document.getElementById("dropdown-container"),wrapper:document.getElementById("wrapper")}}function attachHTMLElementsHandlers(){const e=getHTMLElements();e.searchBtn.addEventListener("click",handleSearchMovieByName),e.searchInput.addEventListener("input",throttledHandleShowDropdownMovieList),e.navBrand.addEventListener("click",handleShowRandomFilmList)}function renderLoader(){const e=getHTMLElements().loader;return Store.state.isLoading?e.classList.remove("hidden"):e.classList.add("hidden")}function resetPaginationAndRender(e){Store.setPageNumber(e),Store.setIsLoading(!0),render()}function handleClickOutsideSearchInput(e){const t=getHTMLElements().formSearch,n=getHTMLElements().searchInput;t.contains(e.target)||(Store.setIsLoadedListVisible(!1),renderDropdownMovieList(),initDropdownMovieListEvent(),n.value="")}function handleYearsNavItemClick(e){e.target.id!==document.getElementById("year-search").id&&(Store.state.sideBarFilter.year!==e.target.value&&Store.setSideBarFilter({year:e.target.value===FILTER_YEAR_TYPE?EVERY_YEAR:e.target.value}),resetPaginationAndRender(1),ApiClient.fetchMovie(Store.state.sideBarFilter,Store.state.pagination.chosenPage).then(e=>{Store.setPagesQuantity(e.pages),Store.setPageType(PAGE_TYPE.FilmList),Store.updateMoviesList(e.docs),Store.setIsLoading(!1),render()}))}function handleShowRandomFilmList(){resetPaginationAndRender(1),ApiClient.fetchRandomMovies(Store.state.pagination.chosenPage).then(e=>{Store.setPagesQuantity(e.pages),Store.setPageType(PAGE_TYPE.StartList),Store.updateMoviesList(e.docs),Store.setIsLoading(!1),render()})}function handleTypesNavItemClick(e){const t=e.target.id;t!==document.getElementById("types-search").id&&(Store.state.sideBarFilter.type!==t&&Store.setSideBarFilter({type:t}),resetPaginationAndRender(1),ApiClient.fetchMovie(Store.state.sideBarFilter,Store.state.pagination.chosenPage).then(e=>{Store.setPagesQuantity(e.pages),Store.setPageType(PAGE_TYPE.FilmList),Store.updateMoviesList(e.docs),Store.setIsLoading(!1),render()}))}function handleGenresNavItemClick(e){const t=document.getElementById("genres-search")?.id;e.target.id!==t&&(Store.state.sideBarFilter.genre!==e.target.textContent&&Store.setSideBarFilter({genre:e.target.textContent}),resetPaginationAndRender(1),ApiClient.fetchMovie(Store.state.sideBarFilter,Store.state.pagination.chosenPage).then(e=>{Store.setPagesQuantity(e.pages),Store.setPageType(PAGE_TYPE.FilmList),Store.updateMoviesList(e.docs),Store.setIsLoading(!1),render()}))}function handlePageClick(e){const t=e.target.id;t&&(Store.setPageNumber(t),loadByPage())}function handleFindMovieFromFilmList(e){onCardClick(e.target.closest(".film-list-element").id)}function handlePreviousPageClick(){Store.state.pagination.chosenPage>1&&Store.setPageNumber(Store.state.pagination.chosenPage-1),loadByPage()}function handleNextPageClick(){Store.state.pagination.chosenPage<Store.state.pagination.pages&&Store.setPageNumber(Store.state.pagination.chosenPage+1),loadByPage()}function loadByPage(){Store.setIsLoading(!0),render();(Store.state.pageType===PAGE_TYPE.StartList?ApiClient.fetchRandomMovies(Store.state.pagination.chosenPage):ApiClient.fetchMovie(Store.state.sideBarFilter,Store.state.pagination.chosenPage)).then(e=>{Store.updateMoviesList(e.docs),Store.setIsLoading(!1),render()})}const throttledHandleShowDropdownMovieList=throttle(e=>{e.preventDefault();const t=getHTMLElements().searchInput.value.trim();if(!t)return Store.setListOfMovies([]),void renderDropdownMovieList();Store.setIsLoadedListVisible(!0),ApiClient.getMoviesByFirstLetters(t).then(e=>{e&&Store.setListOfMovies(e.docs),renderDropdownMovieList(),initDropdownMovieListEvent()})},2e3);function initDropdownMovieListEvent(){const e=document.getElementById("dropdown-list-movies");e&&e.addEventListener("click",handleFindMovieIdAtDropdownList)}function handleFindMovieIdAtDropdownList(e){Store.setIsLoading(!0),render();const t=e.target.closest(".dropdown-movie-item"),n=Number(t.id);ApiClient.getMoviesById(n).then(e=>{Store.updateMovieInfo(e),Store.setPageType(PAGE_TYPE.FilmCard),Store.setIsLoading(!1),render()})}function handleSearchMovieByName(e){e.preventDefault();const t=getHTMLElements().searchInput;t.value&&(Store.setIsLoading(!0),render(),ApiClient.getMoviesByFirstLetters(t.value).then(e=>{const t=getHTMLElements().searchInput,n=e.docs.find(e=>e.name===t.value);e&&(Store.updateMovieInfo(n),Store.setPageType(PAGE_TYPE.FilmCard),Store.setIsLoading(!1),t.value="",render())}))}function handleFindMovieIdAtFavoriteList(e){const t=e.target.closest(".favorite-movie-item");onCardClick(Number(t.id))}function handleSequelsPrequelsClick(e){const t=e.target.closest(".sequel-prequel-item");onCardClick(Number(t.id))}function handleSimilarMoviesClick(e){const t=e.target.closest(".similar-movie-item");onCardClick(Number(t.id))}function onCardClick(e){Store.setIsLoading(!0),render();const t=Store.state.favoritesMovieList.find(t=>t.idMovie===e);t?(Store.updateMovieInfo(t),Store.setPageType(PAGE_TYPE.FilmCard),Store.setIsLoading(!1),render()):ApiClient.getMoviesById(e).then(e=>{Store.updateMovieInfo(e),Store.setPageType(PAGE_TYPE.FilmCard),Store.setIsLoading(!1),render()})}function handleSearchPlayerAtSelect(e){Store.setSelectedVideoPlayer(e.target.value),Store.setPageType(PAGE_TYPE.FilmCard),render()}function handleClickFavorites(){Store.changeCurrentFavoriteMovie(),Store.setPageType(PAGE_TYPE.FilmCard),render()}function initSideBarEvents(){const e=document.getElementById("genres-search"),t=document.getElementById("types-search"),n=document.getElementById("years-film-list");e.addEventListener("click",handleGenresNavItemClick),t.addEventListener("click",handleTypesNavItemClick),n?.addEventListener("change",handleYearsNavItemClick)}function initFilmListEvents(){const e=document.getElementById("film-list-group"),t=document.getElementById("page-container"),n=document.getElementById("next-page"),i=document.getElementById("previous-page");e.addEventListener("click",handleFindMovieFromFilmList),t.addEventListener("click",handlePageClick),n.addEventListener("click",handleNextPageClick),i.addEventListener("click",handlePreviousPageClick)}function render(){renderLoader(),renderSideBar(),initSideBarEvents(),Store.state.pageType===PAGE_TYPE.FilmCard?(renderMovieCard(),initMovieCardEvents()):(renderFilmList(),initFilmListEvents())}function initMovieCardEvents(){const e=document.getElementById("select-player"),t=document.getElementById("watch-btn"),n=document.getElementById("add-to-favorites"),i=document.getElementById("favorites-list"),r=document.getElementById("genres-list"),o=document.getElementById("sequels-and-prequels-container"),a=document.getElementById("similar-movies-container");e?.addEventListener("change",handleSearchPlayerAtSelect),t.addEventListener("click",()=>{document.getElementById("iframe-player").scrollIntoView({behavior:"smooth"})}),n.addEventListener("click",handleClickFavorites),i?.addEventListener("click",handleFindMovieIdAtFavoriteList),r?.addEventListener("click",handleGenresNavItemClick),o?.addEventListener("click",handleSequelsPrequelsClick),a?.addEventListener("click",handleSimilarMoviesClick)}export function startApp(){renderApp(),Store.initStateFromLocalStorage(),Store.setIsLoading(!1),render()}